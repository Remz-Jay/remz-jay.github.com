<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: minecraft | Rem.co: Remco Overdijk]]></title>
  <link href="https://rem.co/blog/categories/minecraft/atom.xml" rel="self"/>
  <link href="https://rem.co/"/>
  <updated>2018-01-25T14:17:37+01:00</updated>
  <id>https://rem.co/</id>
  <author>
    <name><![CDATA[Remco Overdijk]]></name>
    <email><![CDATA[remco@rem.co]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Gentoo: Running a Minecraft 1.8 server]]></title>
    <link href="https://rem.co/blog/2014/11/28/gentoo-running-a-minecraft-1-dot-8-server/"/>
    <updated>2014-11-28T13:36:57+01:00</updated>
    <id>https://rem.co/blog/2014/11/28/gentoo-running-a-minecraft-1-dot-8-server</id>
    <content type="html"><![CDATA[<p>Running a dedicated Minecraft server can be a challenging job. You have to find a balance between performance and usability using &ldquo;server software&rdquo; that doesn&rsquo;t seem to be designed to provide for long running, resilient services.</p>

<p>Being a first-time Minecraft server operator I had to tackle various challenges in order to come up with a way to provide a stable and reliable service to my players. The following article is a recollection of the things I implemented and scripts I wrote in order to run a Minecraft 1.8 server. The scripts mentioned are specific to Gentoo Linux, but could also be used on most other Linux flavours, albeit with some modifications to match that platform&rsquo;s <code>init.d</code> scripts.</p>

<!-- more --> 


<h2>Preparations</h2>

<h3>Screen</h3>

<p>In the scripts we&rsquo;re going to use we use <code>screen</code> as the means to deamonize the Minecraft process. I&rsquo;ve given this a lot of thought, because using <code>screen</code> as a deamonizer feels very wrong  to me when there are dedicated tools (such as the <code>start-stop-daemon</code>) for that particular job. Furthermore, I&rsquo;m more of a <code>tmux</code> guy myself when it comes to terminal multiplexing.</p>

<p>However, after searching the internet, <code>screen</code> seems to be the most popular way of daemonizing Minecraft by far. I don&rsquo;t dare to speculate on wether this is caused by a lack of knowledge in the Minecraft server scene or based on a sound choice.</p>

<p>I have my own reasons for using <code>screen</code> instead of <code>start-stop-deamon</code> or <code>tmux</code>:
-  <code>screen</code> (and/or <code>tmux</code>) allows me to interact with the game&rsquo;s console. If I use <code>start-stop-daemon</code> instead, the process will be truly deamonized, and there is no way to bring it to the foreground anymore to allow for interaction. Why do we <em>need</em> console interaction you might ask? Because we do backups for example. In order to have reliable backups, we have to tell the Minecraft server to flush any changes to the disk and stop saving while the backup is running. This is all done using console commands.
- <code>screen</code> has an awesome command, <code>stuff</code>, that allows us to send commands to a detached (deamonized)  instance. This provides us with the possibility of interacting with a running instance using scripts/services <em>outside</em> of that screen instance.</p>

<p>So, before we continue, make sure <code>screen</code> is installed on your box:</p>

<pre><code># emerge -av app-misc/screen
</code></pre>

<h3>Java SE 8</h3>

<p>My first attempts on running Minecraft 1.8 used the JDK that was present on my box at that time, being <code>IcedTea JDK 6.1.13.3 [icedtea-bin-6]</code>. You <em>can</em> actually use that JDK (or any other Java SE 6 JDK/JRE for that matter), but my installation was haunted by substantial, noticeable lag while the server process was using 100% CPU non-stop (on one core, the  main Minecraft server process being single-threaded) and the console and logs were spammed with these warnings:</p>

<pre><code>[23:52:10] [Server thread/WARN]: Can't keep up! Did the system time change, or is the server overloaded? Running 19381ms behind, skipping 387 tick(s)
</code></pre>

<p>Despite all optimisations that you will read about in this article that were already in effect at that time, the lag remained, and would at times get so bad that Minecraft&rsquo;s  internal watchdog would mark the server as crashed:</p>

<pre><code>[21:21:15] [Server Watchdog/FATAL]: A single server tick took 60.00 seconds (should be max 0.05)
[21:21:15] [Server Watchdog/FATAL]: Considering it to be crashed, server will forcibly shutdown.
[21:21:15] [Server Watchdog/ERROR]: This crash report has been saved to: /mnt/ramdisk/./crash-reports/crash-2014-11-27_21.21.15-server.txt
[21:21:15] [Server Shutdown Thread/INFO]: Stopping server
</code></pre>

<p>After some research on the internet some posts mentioned that upgrading to Java 8 could make all the difference, so I did. And it worked! While CPU usage is still reasonably high (around 70~80% at most times), the lag and warnings are gone, and subsequently, so are the crashes. So, I&rsquo;ll advise to use the same JDK as I did in this article. To install:</p>

<pre><code># emerge -av dev-java/oracle-jdk-bin
</code></pre>

<p><strong>Read</strong> the error you receive from running that command, resolve the fetch restriction by following the instructions in that error message and continue installing. Afterwards:</p>

<pre><code># java-config --list-available-vms
The following VMs are available for generation-2:
1)      IcedTea JDK 6.1.13.3 [icedtea-bin-6]
*)      Oracle JDK 1.8.0.25 [oracle-jdk-bin-1.8] 

# java-config --set-system-vm 2
Now using oracle-jdk-bin-1.8 as your generation-2 system JVM
</code></pre>

<p>The command above marks the newly installed JDK as your system JVM. This might not be a possibility for you if you have other software on your system that is incompatible with Java 8 (or the Oracle JDK). In that case, you can set the installed JDK as the User VM for the user you are using to run Minecraft. To do so:</p>

<pre><code># su &lt;minecraftuser&gt;
$ java-config --set-user-vm 2
Now using oracle-jdk-bin-1.8 as your user JVM
</code></pre>

<h3>RAMDisk</h3>

<p>Being haunted by performance issues, I&rsquo;ve read quite a lot on Minecraft server performance and optimisation. There is one article that stands out from the crowd and is a <em>must</em> read for everyone running Minecraft servers. I encourage you to go and read <a href="http://www.sk89q.com/2013/03/improving-your-minecraft-servers-performance/">sk89q&rsquo;s Improving your Minecraft serverâ€™s performance</a> first before continuing this article.</p>

<p>Among other minor optimisations, such as the Java flags that are used in my setup, one of the biggest influences is the use of a RAMDisk to host your Minecraft setup on. This eliminates any delays caused by <code>iowait</code> due to slow disks and speeds up various tasks, such as loading the map. I use a Dell PowerEdge 1950 III Blade server as the hardware platform for my Minecraft server, and although beefy as it may be for this purpose, it is not equipped with SSD&rsquo;s which is a potential cause for performance degradation. The installation/use of a RAMDisk is quite easy, but there are some drawbacks you have to keep in mind, such as that RAMDisks are not permanent storage. In case you suffer a power outage or kernel panic, the data on your RAMDisk is gone. To counter this issue, you&rsquo;ll have to implement some way to synchronise the RAMDisk from/to persistant storage.</p>

<p>The <code>init.d</code> script we&rsquo;ll later discuss takes care of all this hassle, but in order for it to work, we first have to create the RAMDisk.</p>

<p>Edit your <code>/etc/fstab</code> and add a RAMDisk at a mountpoint of your choise:</p>

<pre><code># vim /etc/fstab
tmpfs                   /mnt/ramdisk    tmpfs           rw,nodev,nosuid,size=2G,uid=1000,gid=1000,mode=1700     0 0
</code></pre>

<p>Adjust the <code>size=</code> parameter to match the amount of spare (unused) RAM you have available and the size of your actual Minecraft installation. (My installation is only 300MB actually, but I have 36GB RAM in this machine which is mostly vacant so I picked a comfortably large disk size). Adjust the <code>uid=</code> and <code>gid=</code> parameters to the id&rsquo;s of the dedicated user you are using to run your Minecraft server with. (Never run trivial services such as this as <code>root</code>!).</p>

<p>Next, create the mountpoint:</p>

<pre><code># mkdir /mnt/ramdisk
</code></pre>

<p>And try to mount the RAMDisk and see if it works:</p>

<pre><code># mount /mnt/ramdisk
# df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda3        63G   48G   13G  80% /
udev             10M  4.0K   10M   1% /dev
tmpfs           7.9G  628K  7.9G   1% /run
shm             7.9G     0  7.9G   0% /dev/shm
cgroup_root      10M     0   10M   0% /sys/fs/cgroup
tmpfs           7.9G   72K  7.9G   1% /tmp
/dev/sdb1       200G  192G  8.2G  96% /mnt/backups
tmpfs           2.0G  297M  1.8G  15% /mnt/ramdisk 
</code></pre>

<h3>Install Minecraft as you normally would</h3>

<p>If you haven&rsquo;t done so already, install a Minecraft like you normally would. For me, that is a directory <code>/home/remco/minecraft</code>  which contains the server <code>.jar</code>, the world and all settings.</p>

<h2>The Scripts</h2>

<p>The <code>init.d</code> script is what makes this setup tick. It does all the heavy lifting. The location for this script is <code>/etc/init.d/minecraft</code>
<figure class='code'><figcaption><span> (minecraft-init.d.sh)</span> <a href='/downloads/code/minecraft-init.d.sh'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#!/sbin/runscript</span>
</span><span class='line'><span class="c"># Copyright 2014 Rem.co Linux Solutions</span>
</span><span class='line'><span class="c"># Distributed under the terms of the GNU General Public License v2</span>
</span><span class='line'><span class="c"># $Header: $</span>
</span><span class='line'>
</span><span class='line'><span class="nv">extra_commands</span><span class="o">=</span><span class="s2">&quot;syncup syncdown backup rotate emptyrestart watch&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">description</span><span class="o">=</span><span class="s2">&quot;Manages a Minecraft installation running under a dedicated user inside a daemonized screen session&quot;</span>
</span><span class='line'><span class="nv">description_syncdown</span><span class="o">=</span><span class="s2">&quot;Synchronizes the RAMdisk back to the persistant storage&quot;</span>
</span><span class='line'><span class="nv">description_syncup</span><span class="o">=</span><span class="s2">&quot;Synchronizes the persistant storage to the RAMdisk&quot;</span>
</span><span class='line'><span class="nv">description_backup</span><span class="o">=</span><span class="s2">&quot;Takes a full backup of the minecraft installation and rotates old backups&quot;</span>
</span><span class='line'><span class="nv">description_rotate</span><span class="o">=</span><span class="s2">&quot;Rotates old backups&quot;</span>
</span><span class='line'><span class="nv">description_emptyrestart</span><span class="o">=</span><span class="s2">&quot;Checks if any users are online in minecraft. If not, restarting the service&quot;</span>
</span><span class='line'><span class="nv">description_watch</span><span class="o">=</span><span class="s2">&quot;Checks if minecraft is still running if it resides in the &#39;started&#39; state. Restarts the service if not.&quot;</span>
</span><span class='line'>
</span><span class='line'>depend<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	need net localmount
</span><span class='line'>	after bootmisc
</span><span class='line'>	use logger
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>start<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	ebegin <span class="s2">&quot;Starting Minecraft&quot;</span>
</span><span class='line'>	<span class="k">if</span> ! sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -list <span class="p">|</span> grep -q <span class="s2">&quot;${SCREENNAME}&quot;</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>		launch <span class="o">||</span> <span class="k">return</span> 1
</span><span class='line'>	<span class="k">else</span>
</span><span class='line'>		eerror <span class="s2">&quot;Minecraft screen session is already present, not launching new one.&quot;</span>
</span><span class='line'>	<span class="k">fi</span>
</span><span class='line'>	eend <span class="nv">$?</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>stop<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	ebegin <span class="s2">&quot;Stopping Minecraft&quot;</span>
</span><span class='line'>	<span class="k">if</span> ! sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -list <span class="p">|</span> grep -q <span class="s2">&quot;${SCREENNAME}&quot;</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>		eerror <span class="s2">&quot;The Minecraft screen session cannot be found so we can&#39;t stop it&quot;</span>
</span><span class='line'>	<span class="k">else</span>
</span><span class='line'>		sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -S <span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span> -p <span class="m">0</span> -X stuff <span class="s2">&quot;stop$(printf \\r)&quot;</span>
</span><span class='line'>		sleep 5
</span><span class='line'>		<span class="c">#Check if the screen session closed cleanly, otherwise kill it with fire.</span>
</span><span class='line'>		<span class="k">if</span> sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -list <span class="p">|</span> grep -q <span class="s2">&quot;${SCREENNAME}&quot;</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>			sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -S <span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span> -X <span class="nb">kill</span>
</span><span class='line'><span class="nb">		</span><span class="k">fi</span>
</span><span class='line'>	<span class="k">fi</span>
</span><span class='line'>	eend <span class="nv">$?</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>reload<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	ebegin <span class="s2">&quot;Reload Minecraft&quot;</span>
</span><span class='line'>	stop
</span><span class='line'>	sleep 3
</span><span class='line'>	start
</span><span class='line'>	eend <span class="nv">$?</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>launch<span class="o">()</span> <span class="o">{</span>
</span><span class='line'> 	<span class="k">if</span> ! mountpoint -q <span class="k">${</span><span class="nv">RAMDISK</span><span class="k">}</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>		mount <span class="k">${</span><span class="nv">RAMDISK</span><span class="k">}</span>
</span><span class='line'>	<span class="k">fi</span>
</span><span class='line'>	sup <span class="o">||</span> <span class="k">return</span> 1
</span><span class='line'>	sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -dmS <span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span> bash -c <span class="s2">&quot;cd ${RAMDISK}; java -server -XX:+UseConcMarkSweepGC -Xms2G -Xmx4G -jar ${JARFILE} nogui&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>sdown<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	rsync --quiet --archive --delete --recursive --force <span class="k">${</span><span class="nv">RAMDISK</span><span class="k">}</span>/ <span class="k">${</span><span class="nv">PERSISTDIR</span><span class="k">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>syncdown<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	ebegin <span class="s2">&quot;Syncing RAMdisk to Persistant Storage&quot;</span>
</span><span class='line'>	sdown <span class="o">||</span> <span class="k">return</span> 1
</span><span class='line'>	eend <span class="nv">$?</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>sup<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	rsync --quiet --archive <span class="k">${</span><span class="nv">PERSISTDIR</span><span class="k">}</span>/ <span class="k">${</span><span class="nv">RAMDISK</span><span class="k">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>syncup<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	ebegin <span class="s2">&quot;Syncing Persistant Storage to RAMdisk&quot;</span>
</span><span class='line'>	sup <span class="o">||</span> <span class="k">return</span> 1
</span><span class='line'>	eend <span class="nv">$?</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>backup<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	ebegin <span class="s2">&quot;Taking a backup&quot;</span>
</span><span class='line'>	<span class="k">if</span> ! sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -list <span class="p">|</span> grep -q <span class="s2">&quot;${SCREENNAME}&quot;</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>		eerror <span class="s2">&quot;Minecraft is not running, not taking a live backup&quot;</span>
</span><span class='line'>	<span class="k">fi</span>
</span><span class='line'>	<span class="nv">H</span><span class="o">=</span><span class="k">$(</span>date +<span class="s2">&quot;%H&quot;</span><span class="k">)</span>
</span><span class='line'>	<span class="nv">NOW</span><span class="o">=</span><span class="k">$(</span>date +<span class="s2">&quot;%H:%M&quot;</span><span class="k">)</span>
</span><span class='line'>	sdown <span class="o">||</span> <span class="k">return</span> 1
</span><span class='line'>	sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -S <span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span> -p <span class="m">0</span> -X stuff <span class="s2">&quot;say Hourly backup for $NOW is starting. The World is no longer saving...$(printf \\r)&quot;</span>
</span><span class='line'>	sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -S <span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span> -p <span class="m">0</span> -X stuff <span class="s2">&quot;save-off$(printf \\r)&quot;</span>
</span><span class='line'>	sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -S <span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span> -p <span class="m">0</span> -X stuff <span class="s2">&quot;save-all$(printf \\r)&quot;</span>
</span><span class='line'>	sleep 5
</span><span class='line'>	sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> /usr/bin/time -f <span class="s2">&quot;%e sec at %P CPU&quot;</span> -o /tmp/mctime sh -c <span class="s2">&quot;sync; sleep 5; sudo -u ${RUNAS} nice tar czf ${BACKUPDIR}/${PREFIX}$(date +&quot;</span>%d-%m-%Y-%H<span class="s2">&quot;).tar.gz -C ${RAMDISK} .&quot;</span>
</span><span class='line'>	sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -S <span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span> -p <span class="m">0</span> -X stuff <span class="s2">&quot;save-on$(printf \\r)&quot;</span>
</span><span class='line'>	sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -S <span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span> -p <span class="m">0</span> -X stuff <span class="s2">&quot;say Hourly backup for $NOW is complete and ran for $(cat /tmp/mctime). The World is saving once more.$(printf \\r)&quot;</span>
</span><span class='line'>	rm /tmp/mctime
</span><span class='line'>	<span class="k">if</span> <span class="o">((</span> <span class="m">19</span> &lt;<span class="o">=</span> 10#<span class="nv">$H</span> <span class="o">&amp;&amp;</span> 10#<span class="nv">$H</span> &lt; <span class="m">23</span> <span class="o">))</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>		rot <span class="o">||</span> <span class="k">return</span> 1
</span><span class='line'>	<span class="k">fi</span>
</span><span class='line'>	eend <span class="nv">$?</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>rot<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	<span class="o">[</span> -d <span class="k">${</span><span class="nv">BACKUPDIR</span><span class="k">}</span>/daily-saves <span class="o">]</span> <span class="o">||</span> mkdir -p <span class="k">${</span><span class="nv">BACKUPDIR</span><span class="k">}</span>/daily-saves
</span><span class='line'>	find <span class="k">${</span><span class="nv">BACKUPDIR</span><span class="k">}</span> -maxdepth <span class="m">1</span> -type f -name <span class="s2">&quot;${PREFIX}$(date -d &quot;</span>yesterday 20:00 <span class="s2">&quot; &#39;+%d-%m-%Y-%H&#39;).tar.gz&quot;</span> <span class="se">\</span>
</span><span class='line'>		-exec cp <span class="o">{}</span> <span class="k">${</span><span class="nv">BACKUPDIR</span><span class="k">}</span>/daily-saves/daily_<span class="k">$(</span>date -d <span class="s2">&quot;yesterday 20:00 &quot;</span> <span class="s1">&#39;+%d-%m-%Y&#39;</span><span class="k">)</span>.tar.gz <span class="se">\;</span>
</span><span class='line'>	<span class="k">if</span> <span class="o">[</span> -f <span class="k">${</span><span class="nv">BACKUPDIR</span><span class="k">}</span>/daily-saves/daily_<span class="k">$(</span>date -d <span class="s2">&quot;yesterday 20:00 &quot;</span> <span class="s1">&#39;+%d-%m-%Y&#39;</span><span class="k">)</span>.tar.gz <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>		find <span class="k">${</span><span class="nv">BACKUPDIR</span><span class="k">}</span> -maxdepth <span class="m">1</span> -type f -name <span class="s2">&quot;${PREFIX}$(date -d &quot;</span>yesterday 20:00 <span class="s2">&quot; &#39;+%d-%m-%Y&#39;)-*.tar.gz&quot;</span> -exec rm <span class="o">{}</span> <span class="se">\;</span>
</span><span class='line'>	<span class="k">else</span>
</span><span class='line'>		ewarn <span class="s2">&quot;Could not locate yesterday&#39;s daily save. Not rotating yesterday&#39;s hourly saves.&quot;</span>
</span><span class='line'>	<span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>rotate<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	ebegin <span class="s2">&quot;Starting daily backup rotation&quot;</span>
</span><span class='line'>	rot <span class="o">||</span> <span class="k">return</span> 1
</span><span class='line'>	eend <span class="nv">$?</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>emptyrestart<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -S <span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span> -p <span class="m">0</span> -X hardcopy /tmp/<span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span>.dump.1
</span><span class='line'>	sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -S <span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span> -p <span class="m">0</span> -X stuff <span class="s2">&quot;list$(printf \\r)&quot;</span>
</span><span class='line'>	<span class="c"># We need to wait for the command to complete, or the diff will we unreliable</span>
</span><span class='line'>	sleep 1
</span><span class='line'>	sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -S <span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span> -p <span class="m">0</span> -X hardcopy /tmp/<span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span>.dump.2
</span><span class='line'>	<span class="nv">NUMP</span><span class="o">=</span><span class="k">$(</span>diff -u /tmp/<span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span>.dump.<span class="o">{</span>1,2<span class="o">}</span> <span class="p">|</span> grep -E <span class="s2">&quot;^\+&quot;</span> <span class="p">|</span> grep -Po <span class="s1">&#39;\d+/\d+&#39;</span> <span class="p">|</span> cut -d<span class="s1">&#39;/&#39;</span> -f1<span class="k">)</span>
</span><span class='line'>	rm /tmp/<span class="k">${</span><span class="nv">SCREENNAME</span><span class="k">}</span>.dump.<span class="o">{</span>1,2<span class="o">}</span>
</span><span class='line'>	<span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">NUMP</span><span class="k">}</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>		reload <span class="o">||</span> <span class="k">return</span> 1
</span><span class='line'>	<span class="k">else</span>
</span><span class='line'>		ewarn <span class="s2">&quot;There are ${NUMP} player(s) online. Not restarting.&quot;</span>
</span><span class='line'>	<span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>watch<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>	<span class="k">if</span> <span class="o">[</span> <span class="k">$(</span>rc-service minecraft status <span class="p">|</span> grep -i <span class="s2">&quot;started&quot;</span> <span class="p">|</span> wc -l<span class="k">)</span> -eq <span class="m">1</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>		einfo <span class="s2">&quot;MC should be running&quot;</span>
</span><span class='line'>		<span class="k">if</span> ! sudo -u <span class="k">${</span><span class="nv">RUNAS</span><span class="k">}</span> screen -list <span class="p">|</span> grep -q <span class="s2">&quot;${SCREENNAME}&quot;</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>                	ewarn <span class="s2">&quot;But it is not! Restarting service&quot;</span>
</span><span class='line'>			sdown <span class="o">||</span> <span class="k">return</span> 1
</span><span class='line'>			launch <span class="o">||</span> <span class="k">return</span> 1
</span><span class='line'>		<span class="k">else</span>
</span><span class='line'>			einfo <span class="s2">&quot;And it is. Good.&quot;</span>
</span><span class='line'>		<span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>	<span class="k">else</span>
</span><span class='line'>		einfo <span class="s2">&quot;MC is in stopped state. Not doing anything.&quot;</span>
</span><span class='line'>	<span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The <code>init.d</code> script loads settings from a <code>conf.d</code> script. The location for
this script is <code>/etc/conf.d/minecraft</code>
<figure class='code'><figcaption><span> (minecraft-conf.d.sh)</span> <a href='/downloads/code/minecraft-conf.d.sh'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">BACKUPDIR</span><span class="o">=</span>/mnt/backups/minecraft
</span><span class='line'><span class="nv">RAMDISK</span><span class="o">=</span>/mnt/ramdisk
</span><span class='line'><span class="nv">PERSISTDIR</span><span class="o">=</span>/home/remco/minecraft
</span><span class='line'><span class="nv">PREFIX</span><span class="o">=</span><span class="s2">&quot;mc-backup_&quot;</span>
</span><span class='line'><span class="nv">RUNAS</span><span class="o">=</span><span class="s2">&quot;remco&quot;</span>
</span><span class='line'><span class="nv">SCREENNAME</span><span class="o">=</span><span class="s2">&quot;minecraft&quot;</span>
</span><span class='line'><span class="c">#JARFILE=&quot;minecraft_server.1.8.1.jar&quot;</span>
</span><span class='line'><span class="c">#JARFILE=&quot;spigot1649.jar&quot;</span>
</span><span class='line'><span class="nv">JARFILE</span><span class="o">=</span><span class="s2">&quot;spigot-1.8.jar&quot;</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>Finishing up</h2>

<ul>
<li>Install cronjobs as <code>root</code>:</li>
</ul>


<pre><code># crontab -e
</code></pre>

<ul>
<li>Add these lines:
&#8220;`
0 * * * *       /etc/init.d/minecraft backup 1> /dev/null</li>
<li><ul>
<li><ul>
<li><ul>
<li><ul>
<li><pre><code>/sbin/rc-service minecraft watch 1&gt; /dev/null
</code></pre>

<p>&#8220;`</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Set service to start automatically:</p></li>
</ul>


<pre><code>rc-update add minecraft default
</code></pre>
]]></content>
  </entry>
  
</feed>
